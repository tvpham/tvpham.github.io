<!DOCTYPE html>
<html>
    <head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="/style.css">

	<title>heatmap</title>

        <script type="text/javascript" async
                src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML">
        </script>
        
    </head>
    <body>
        <div class="flexbox">
            
	    <header0>
	        <svg width="64" height="64"  align="center">
                    
                    <text x="0" y="40" font-family="monospace" font-size="36" stroke="none" fill="seagreen">
                        tp$
                    </text>
                </svg>
	        <div class="box">R scripts</div>
            </header0>

            
            <div class="navrow">
	        <div class="nav"><a href="../" id="start">Start</a></div>
  	        <div class="nav"><a class="active" href="." id="heatmap">Heatmap & clustering</a></div>
	    </div>
	    

	    <div class="mainrow">
	        <div class="content">
                    <p><code>tp$heatmap</code> is a wrapper function for the heatmap.2 function in the gplots R package. The first step is to make it available to your R environment</p>
                    <pre class="r"><code>source(&quot;http://www.hanoilang.org/tp.r&quot;)</code></pre>
                    <p>Load an example dataset (or pointing to your local, tab-delimitated data file)</p>
                    <pre class="r"><code>d &lt;- tp$load(&quot;https://tvpham.github.io/data/example-3groups.txt&quot;)</code></pre>
                    <p>Check the data by using the <code>head</code>, <code>tail</code>, and <code>dim</code> functions. You should get something like this in RStudio.</p>
                    <pre class="r"><code>head(d)</code></pre>
                    <pre><code>##    a1  a2  a3  b1  b2  b3  c1  c2
## 1 624 496 509 414 394 375 325 288
## 2 615 854 930 341 523 360 359 329
## 3 553 560 745 819 490 481 480 500
## 4 525 412 401 354 321 310 258 228
## 5 484 284 315 268 282 307 270 298
## 6 482 348 400 242 365 367  81 118</code></pre>
                    <p>In genomics data analysis, typically columns are samples and rows are genes. We are often interested in the up and down patterns of genes. Thus, the heatmap often shows the z-scores for each gene across samples (see the z-scores section below). In our example, the data table <code>d</code> can be transformed to z-scores by the statement <code>t(scale(t(d)))</code>. We can show the heatmap and hierachical clusterings of the data stored in <code>d</code> as follows</p>
                    <pre class="r"><code>tp$heatmap(t(scale(t(d))))</code></pre>
                    <pre><code>## Using euclidean distance for columns.
## Using complete linkage for columns.
## Using euclidean distance for rows.
## Using complete linkage for rows.</code></pre>
                    <p><img src="heatmap_files/figure-html/unnamed-chunk-4-1.svg" width="95%" /></p>
                    <div id="z-scores" class="section level2">
                        <h2>Z-scores</h2>
                        <p>What is <code>t(scale(t(d))))</code>? The <code>t</code> function transposes the data (columns become rows and vice versa). The <code>scale</code> function transforms each data column into z-scores. Thus, this statement converts each row of <code>d</code> into z-scores.</p>
                        <p>Specifically, the z-score transformation centers data around zero with unit variance <span class="math display">\[
                            z=  \frac{x-\mbox{mean}(x)}{\mbox{standard deviation}(x)}
                            \]</span></p>
                        <p>Let us check with the first row of our data</p>
                        <pre class="r"><code>x &lt;- as.numeric(d[1,])
(x-mean(x))/sd(x)</code></pre>
                        <pre><code>## [1]  1.7883960  0.6197186  0.7384124 -0.1289654 -0.3115712 -0.4850468
## [7] -0.9415614 -1.2793822</code></pre>
                        <p>This should be the same as the first row of the transformed data</p>
                        <pre class="r"><code>head(t(scale(t(d))))</code></pre>
                        <pre><code>##              a1         a2         a3          b1          b2          b3
## [1,]  1.7883960  0.6197186 0.73841239 -0.12896538 -0.31157122 -0.48504678
## [2,]  0.3161375  1.3086741 1.62429247 -0.82174976 -0.06592686 -0.74284517
## [3,] -0.1949561 -0.1414388 1.27294896  1.83870405 -0.67661251 -0.74542056
## [4,]  1.8347721  0.6423681 0.52629337  0.03033771 -0.31788647 -0.43396120
## [5,]  2.4050576 -0.4161243 0.02115886 -0.64181890 -0.44433616 -0.09168841
## [6,]  1.2907998  0.3384685 0.70802991 -0.41486821  0.45928665  0.47350055
##              c1         c2
## [1,] -0.9415614 -1.2793822
## [2,] -0.7469980 -0.8715842
## [3,] -0.7530659 -0.6001591
## [4,] -0.9826781 -1.2992455
## [5,] -0.6136071 -0.2186416
## [6,] -1.5590872 -1.2961300</code></pre>
                    </div>
                    <div id="row-names-and-column-names" class="section level2">
                        <h2>Row names and column names</h2>
                        <p>We want to rotate the figure by skipping the outter transpose <code>t()</code>, showing sample names with colors</p>
                        <pre class="r"><code>tp$heatmap(scale(t(d)),
           row_labels = colnames(d),
           row_label_colors = c(&quot;red&quot;, &quot;red&quot;, &quot;red&quot;, &quot;blue&quot;, &quot;blue&quot;,
                                &quot;blue&quot;,&quot;green&quot;, &quot;green&quot;),
           row_margin = 5)</code></pre>
                        <pre><code>## Using euclidean distance for columns.
## Using complete linkage for columns.
## Using euclidean distance for rows.
## Using complete linkage for rows.</code></pre>
                        <p><img src="heatmap_files/figure-html/unnamed-chunk-7-1.svg" width="95%" /></p>
                    </div>
                    <div id="label-font-size" class="section level2">
                        <h2>Label font size</h2>
                        <p>Try to add parameter <code>cexRow = 2.5</code> to get a more readable text labels (2.5 times bigger). If you have only a few rows (genes), it might be visually pleasing to add separators between cells by setting the <code>sep</code> parameter to <code>TRUE</code>. Let us try with the first 20 rows of our data</p>
                        <pre class="r"><code>tp$heatmap(scale(t(d[1:20,])),
           row_labels = colnames(d),
           row_label_colors = c(&quot;red&quot;, &quot;red&quot;, &quot;red&quot;, &quot;blue&quot;, 
                                &quot;blue&quot;, &quot;blue&quot;,&quot;green&quot;, &quot;green&quot;),
           row_margin = 5,
           cexRow = 2.5,
           sep = TRUE)</code></pre>
                        <pre><code>## Using euclidean distance for columns.
## Using complete linkage for columns.
## Using euclidean distance for rows.
## Using complete linkage for rows.</code></pre>
                        <p><img src="heatmap_files/figure-html/unnamed-chunk-8-1.svg" width="95%" /></p>
                    </div>
                    <div id="color-key-code" class="section level2">
                        <h2>Color key code</h2>
                        <p>We can disable the color key (<code>key = FALSE</code>) and column clustering (<code>col_data = NULL</code>)</p>
                        <pre class="r"><code>tp$heatmap(scale(t(d[1:20,])),
           row_labels = colnames(d),
           row_label_colors = c(&quot;red&quot;, &quot;red&quot;, &quot;red&quot;, &quot;blue&quot;, 
                                &quot;blue&quot;, &quot;blue&quot;,&quot;green&quot;, &quot;green&quot;),
           row_margin = 5,
           cexRow = 2.5,
           sep = TRUE,
           key = FALSE,
           
           col_data = NULL
           )</code></pre>
                        <pre><code>## Using euclidean distance for rows.
## Using complete linkage for rows.</code></pre>
                        <p><img src="heatmap_files/figure-html/unnamed-chunk-9-1.svg" width="95%" /></p>
                    </div>
                    <div id="top-spacing-and-left-spacing" class="section level2">
                        <h2>Top spacing and left spacing</h2>
                        <p>Notice the large white space at the top of the figure above. That is where the parameter <code>lhei</code> comes in (similarly, <code>lwid</code> for space on the left). This parameter should be a vector of 2 components, reflecting the ratio between the top space for color key (+ column clustering tree) and the botton space for heatmap (+ row clustering tree). The default value of [1.5, 4] means that the height of the heatmap should be 4/1.5 ~ 2.7 times bigger than the top space. By making the space for heatmap much bigger than the top, we effective reduce the top space.</p>
                        <pre class="r"><code>tp$heatmap(scale(t(d[1:20,])),
           row_labels = colnames(d),
           row_label_colors = c(&quot;red&quot;, &quot;red&quot;, &quot;red&quot;, &quot;blue&quot;, 
                                &quot;blue&quot;, &quot;blue&quot;,&quot;green&quot;, &quot;green&quot;),
           row_margin = 5,
           cexRow = 2.5,
           sep = TRUE,
           key = FALSE,
           
           col_data = NULL,
           
           lhei = c(1, 100))</code></pre>
                        <pre><code>## Using euclidean distance for rows.
## Using complete linkage for rows.</code></pre>
                        <p><img src="heatmap_files/figure-html/unnamed-chunk-10-1.svg" width="95%" /></p>
                        <p>We can turn off the row clustering as well (<code>row_data = NULL</code>)</p>
                        <pre class="r"><code>tp$heatmap(scale(t(d[1:20,])),
           
           row_labels = colnames(d),
           row_label_colors = c(&quot;red&quot;, &quot;red&quot;, &quot;red&quot;, &quot;blue&quot;, 
                                &quot;blue&quot;, &quot;blue&quot;,&quot;green&quot;, &quot;green&quot;),
           row_margin = 5,
           cexRow = 2.5,
           sep = TRUE,
           key = FALSE,
           
           col_data = NULL,
           row_data = NULL,
           
           lhei = c(1, 100),
           lwid = c(1, 100))</code></pre>
                        <p><img src="heatmap_files/figure-html/unnamed-chunk-11-1.svg" width="95%" /></p>
                    </div>
                    <div id="display-raw-data" class="section level2">
                        <h2>Display raw data</h2>
                        <p>If you do not want to display z-score data, set <code>zscore</code> to <code>FALSE</code>, and provide a new color palette. This is because the default palette is suitable for z-score data only. We will try a palette with 32 colors going from yellow to green as follows</p>
                        <pre class="r"><code>tp$heatmap(d,
           zscore = FALSE,
           color = colorRampPalette(c(&quot;yellow&quot;, &quot;green&quot;))(32))</code></pre>
                        <pre><code>## Using euclidean distance for columns.
## Using complete linkage for columns.
## Using euclidean distance for rows.
## Using complete linkage for rows.</code></pre>
                        <p><img src="heatmap_files/figure-html/unnamed-chunk-12-1.svg" width="95%" /></p>
                        <p>One can observe that the some rows are more intense than others across all samples (you decide if that is interesting!). We can set a minimum value and a maximum value for the heatmap. Values outside of the range will get the extreme colors.</p>
                        <pre class="r"><code>tp$heatmap(d,
           zscore = FALSE,
           color = colorRampPalette(c(&quot;yellow&quot;, &quot;green&quot;))(32),
           color_min = 5,
           color_max = 30)</code></pre>
                        <pre><code>## Using euclidean distance for columns.
## Using complete linkage for columns.
## Using euclidean distance for rows.
## Using complete linkage for rows.</code></pre>
                        <p><img src="heatmap_files/figure-html/unnamed-chunk-13-1.svg" width="95%" /></p>
                    </div>
                    <div id="clustering-parameters" class="section level2">
                        <h2>Clustering parameters</h2>
                        <p>We can ignore the row clustering by setting <code>row_data</code> to <code>NULL</code>, and in addition, use the Spearman distance (1-Spearman correlation) for column clustering.</p>
                        <pre class="r"><code>tp$heatmap(d,
           zscore = FALSE,
           color = colorRampPalette(c(&quot;yellow&quot;, &quot;green&quot;))(32),
           row_data = NULL,
           col_distance = &quot;spearman&quot;)</code></pre>
                        <pre><code>## Using Spearman distance for columns.
## Using complete linkage for columns.</code></pre>
                        <p><img src="heatmap_files/figure-html/unnamed-chunk-14-1.svg" width="95%" /></p>
                        <p>Note that the dendrogram for columns has changed. We can use the Spearman distance and Ward linkage for column clustering while using z-scores for heatmap and default clustering for rows</p>
                        <pre class="r"><code>tp$heatmap(t(scale(t(d))),
           col_data = d,
           col_distance = &quot;spearman&quot;,
           col_linkage = &quot;ward.D2&quot;)</code></pre>
                        <pre><code>## Using Spearman distance for columns.
## Using ward.D2 linkage for columns.
## Using euclidean distance for rows.
## Using complete linkage for rows.</code></pre>
                        <p><img src="heatmap_files/figure-html/unnamed-chunk-15-1.svg" width="95%" /></p>
                    </div>
                    <div id="extra-column-annotations" class="section level2">
                        <h2>Extra column annotations</h2>
                        <p>The reason I modified the <code>heatmap.2</code> function is because I want to display multiple color bars on top of the columns for extra data annotation. The parameter <code>col_color_bar</code> should be a list where each element corresponds to a color bar. Try</p>
                        <pre class="r"><code>tp$heatmap(t(scale(t(d))),
           col_color_bar = list(&quot;Subtype&quot; = c(&quot;red&quot;, &quot;red&quot;, &quot;red&quot;, 
                                              &quot;blue&quot;, &quot;blue&quot;, &quot;blue&quot;,
                                              &quot;green&quot;, &quot;green&quot;),
                                &quot;MSI status&quot; = c(&quot;orange&quot;, &quot;orange&quot;,
                                                 &quot;orange&quot;, &quot;steelblue&quot;,
                                                 &quot;steelblue&quot;, &quot;steelblue&quot;, 
                                                 &quot;steelblue&quot;, &quot;steelblue&quot;)),
           col_data = d,
           col_distance = &quot;spearman&quot;,
           col_linkage = &quot;ward.D2&quot;)</code></pre>
                        <pre><code>## Using Spearman distance for columns.
## Using ward.D2 linkage for columns.
## Using euclidean distance for rows.
## Using complete linkage for rows.</code></pre>
                        <p><img src="heatmap_files/figure-html/unnamed-chunk-16-1.svg" width="95%" /></p>
                        <p>We now add labels to columns as for rows. By default, column labels are rotated by 45 degree. We can alter this with the parameter <code>col_label_rotated</code></p>
                        <pre class="r"><code>tp$heatmap(t(scale(t(d))),
           col_color_bar = list(&quot;Subtype&quot; = c(&quot;red&quot;, &quot;red&quot;, &quot;red&quot;, 
                                              &quot;blue&quot;, &quot;blue&quot;, &quot;blue&quot;,
                                              &quot;green&quot;, &quot;green&quot;),
                                &quot;MSI status&quot; = c(&quot;orange&quot;, &quot;orange&quot;,
                                                 &quot;orange&quot;, &quot;steelblue&quot;,
                                                 &quot;steelblue&quot;, &quot;steelblue&quot;, 
                                                 &quot;steelblue&quot;, &quot;steelblue&quot;)),
           col_data = d,
           col_distance = &quot;spearman&quot;,
           col_linkage = &quot;ward.D2&quot;,
           col_labels = colnames(d),
           col_label_colors = c(&quot;red&quot;, &quot;red&quot;, &quot;red&quot;, &quot;blue&quot;, 
                                &quot;blue&quot;, &quot;blue&quot;,&quot;green&quot;, &quot;green&quot;),
           col_margin = 5,
           cexCol = 2.5,
           col_label_rotated = 90)</code></pre>
                        <pre><code>## Using Spearman distance for columns.
## Using ward.D2 linkage for columns.
## Using euclidean distance for rows.
## Using complete linkage for rows.</code></pre>
                        <p><img src="heatmap_files/figure-html/unnamed-chunk-17-1.svg" width="95%" /></p>
                    </div>
                    <div id="troubleshooting" class="section level2">
                        <h2>Troubleshooting</h2>
                        <p>At times R cannot make the intended graphical draw because of the lack of drawing space. Make the figure area bigger. To clean up the error, call <code>dev.off()</code> a few times!</p>
                    </div>

	        </div>

                <div class="navtoc">
                    <p style="color:green;font-size: 120%; font-weight:bold;">On this page</p>
                    <ul style="list-style-type:square">                            
                        <li><a href="#z-scores">Z-scores</a></li>
                        <li><a href="#row-names-and-column-names">Row names and column names</a></li>
                        <li><a href="#label-font-size">Label font size</a></li>
                        <li><a href="#color-key-code">Color key code</a></li>
                        <li><a href="#top-spacing-and-left-spacing">Top spacing and left spacing</a></li>
                        <li><a href="#display-raw-data">Display raw data</a></li>
                        <li><a href="#clustering-parameters">Clustering parameters</a></li>
                        <li><a href="#extra-column-annotations">Extra column annotations</a></li>
                        <li><a href="#troubleshooting">Troubleshooting</a></li>
                    </ul>
                </div>
                
	    </div>

            <footer>&copy; 2017 Thang V. Pham, all rights reserved.</footer>
        </div>
    </body>
</html>

